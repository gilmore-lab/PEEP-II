---
title: "PEEP-II-Script-Orders"
author: "rogilmore"
date: "`r Sys.time()`"
output: html_document
---

```{r set-up}
# Source libraries
library(ggplot2)
library(dplyr)
library(ggplot2)
library(xlsx)
library(knitr)
```

```{r knitr-defaults}
opts_knit$set(progress = FALSE, warnings = FALSE, eval = TRUE, echo = TRUE, tidy = TRUE, message = FALSE)
```

```{r session-info}
sessionInfo()
```

```{r define-paths}
# Define paths
dir_xlsx <- 'xlsx'
dir_csv <- 'csv'
dir_figs <- 'figs'

peep_xlsx <- 'peep-run-orders.xlsx'

# Source external functions
source(paste('make_peep_order_fr_xlsx.R', sep="/"))
```

There are four orders, with two runs in each. Sequences should start and end with a neutral prosody.

```{r load-data}
# Function loads .xlsx and turns into a data frame

# Should do list-wise, but faster to do this
o1r1 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 1, 1, 1)
o1r2 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 2, 1, 2)
o2r1 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 3, 2, 1)
o2r2 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 4, 2, 2)
o3r1 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 5, 3, 1)
o3r2 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 6, 3, 2)
o4r1 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 7, 4, 1)
o4r2 <- make_peep_order_fr_xlsx(paste(dir_xlsx, peep_xlsx, sep="/"), 8, 4, 2)

peep_orders <- rbind(o1r1, o1r2, o2r1, o2r2, o3r1, o3r2, o4r1, o4r2 )

# Make Run, Order, Stim_index a factor
peep_orders$Run = as.factor(peep_orders$Run)
```

Visualize orders

```{r run-order-plot}
library(ggplot2)

p <- ggplot(peep_orders) +
  aes(x=Stim_index, y=Emotion, color=Emotion) + 
  geom_point()
p
```

This seems to show that we need to normalize/recode the Happy, Angry, Neutral levels.

```{r recode-levels}
levels(peep_orders$Emotion)

# Now rename to fix
levels(peep_orders$Emotion) <- list(Angry = c("Angry", "Angry "), 
                                    Happy = c("Happy", "Happy "),
                                    Neutral = c("Neu", "Neut"),
                                    Sad = c("Sad"),
                                    Silence = c("Sil"))
levels(peep_orders$Emotion)
```

Ok, so that's fixed. Let's replot by run and order.

```{r run-orders-plot-v2}
p <- ggplot(peep_orders) +
  aes(x=Stim_index, y=Emotion, 
      color=Emotion,
      shape = Speaker) + 
  geom_point() +
  facet_grid(Order ~ Run)
p
```

Now, let's look at scripts.

```{r}
peep_filtered <- peep_orders %>%
  filter(Emotion %in% c('Angry', 'Happy', 'Sad', 'Neutral'),
         Speaker %in% c('Mom', 'Unf'))
with(peep_filtered, xtabs(formula = ~ Emotion + Script + Speaker, drop.unused.levels = TRUE))
```

Imbalanced between Neutral 3a and 4a for Mom; Neutrals for b.

```{r}
# Split Script and Script_version
peep_orders$Script_version <- peep_orders$Script

levels(peep_orders$Script_version) <- list(a = c("1a", "2a", "3a", "4a"),
                                           b = c("1b", "2b", "3b", "4b"))

levels(peep_orders$Script) <- list('1' = c("1a", "1b"), 
                                   '2' = c("2a", "2b"),
                                   '3' = c("3a", "3b"),
                                   '4' = c("4a", "4b"),
                                   '0' = c("None", "NA", ""))
```

Now, we can plot scripts.

```{r run-orders-plot-by-script}
p <- ggplot(peep_orders) +
  aes(x=Stim_index, y=Emotion, 
      color = Emotion,
      shape = Script) + 
  geom_point() +
  facet_grid(Order ~ Run)
p
```

By version.

```{r run-orders-plot-by-version}
p <- ggplot(peep_orders) +
  aes(x=Stim_index, y=Emotion, 
      color = Emotion,
      shape = Script_version) + 
  geom_point() +
  facet_grid(Order ~ Run)
p
```

## Visualizing balance in design

Do we have the same number of prosodies for each speaker within each of the four orders?

```{r}
# Here's a better way to visualize whether we are balanced by orders
peep_filtered <- peep_orders %>%
  filter(Emotion %in% c('Angry', 'Happy', 'Sad', 'Neutral'))

xtabs( formula = ~ Speaker + Emotion + Order, data = peep_filtered, drop.unused.levels = TRUE)
```

